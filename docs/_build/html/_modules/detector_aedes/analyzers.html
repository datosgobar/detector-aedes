

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>detector_aedes.analyzers &mdash; Detector Aedes 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="https://media.readthedocs.org/css/sphinx_rtd_theme.css" type="text/css" />
  
    <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Detector Aedes 0.1.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Detector Aedes
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Detector Aedes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MANUAL.html">Manual de uso del módulo <code class="docutils literal"><span class="pre">detector_aedes</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../HISTORY.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Detector Aedes</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>detector_aedes.analyzers</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for detector_aedes.analyzers</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Para el procesamiento de imagenes</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">transform</span>
<span class="kn">from</span> <span class="nn">skimage.color</span> <span class="k">import</span> <span class="n">rgb2gray</span><span class="p">,</span> <span class="n">rgb2hsv</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="k">import</span> <span class="n">regionprops</span><span class="p">,</span> <span class="n">label</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">feature</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="k">import</span> <span class="n">resize</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">hough_line</span><span class="p">,</span> <span class="n">hough_line_peaks</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="k">import</span> <span class="n">threshold_otsu</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">canny</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">segmentation</span>
<span class="kn">from</span> <span class="nn">skimage.future</span> <span class="k">import</span> <span class="n">graph</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">morphology</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">measure</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">pairwise_distances</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="k">import</span> <span class="n">GaussianMixture</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="k">import</span> <span class="n">convolve2d</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ymlfile</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ymlfile</span><span class="p">)</span>
<span class="n">cfg_images</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="StickAnalizer"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizer">[docs]</a><span class="k">class</span> <span class="nc">StickAnalizer</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Clase base para buscar el bajalenguas.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowres_width</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowres_width</span> <span class="o">=</span> <span class="n">lowres_width</span>

<div class="viewcode-block" id="StickAnalizer.set_current_image"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizer.set_current_image">[docs]</a>    <span class="k">def</span> <span class="nf">set_current_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Definir la imagen de trabajo.&quot;&quot;&quot;</span>
        <span class="n">orig_size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">orig_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">orig_size</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_width</span><span class="p">)</span>
        <span class="n">new_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orig_size</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">image_lowres</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">new_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_im</span> <span class="o">=</span> <span class="n">image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres</span> <span class="o">=</span> <span class="n">image_lowres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres_g</span> <span class="o">=</span> <span class="n">rgb2gray</span><span class="p">(</span><span class="n">image_lowres</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StickAnalizerHough"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerHough">[docs]</a><span class="k">class</span> <span class="nc">StickAnalizerHough</span><span class="p">(</span><span class="n">StickAnalizer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Busca lineas de Hough paralelas&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StickAnalizerHough.get_limits"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerHough.get_limits">[docs]</a>    <span class="k">def</span> <span class="nf">get_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_width_proportion</span><span class="o">=</span><span class="mf">0.45</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Busca dos lineas paralelas que correspondan al bajalenguas</span>

<span class="sd">        Args:</span>
<span class="sd">            max_width_proportion (float): Maxima proporcion del alto de la</span>
<span class="sd">                imagen (considerada apaisada) que puede abarcar el ancho del</span>
<span class="sd">                bajalenguas.</span>
<span class="sd">        Returns:</span>
<span class="sd">            status (str): Una descripcion del resultado de la busqueda.</span>
<span class="sd">            limits ([angles, dists]): Contiene dos numpy arrays. El primero</span>
<span class="sd">                contiene dos angulos y el segundo dos distancias. Cada par de</span>
<span class="sd">                angulo-distancia define la recta de arriba y de abajo del bajalenguas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_angle_diff</span> <span class="o">=</span> <span class="mf">5.</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">im_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres_g</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">im_width</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres_g</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">canny</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres_g</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">hough_line</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">hough_line_peaks</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">num_peaks</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                                  <span class="n">min_distance</span><span class="o">=</span><span class="n">min_dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="c1"># Normalizo al ancho de la imagen</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">im_width</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dangles</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">angles</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">dangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">dangles</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dangles</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
        <span class="n">dangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">dangles</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">dangles</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dangles</span><span class="p">),</span> <span class="n">dangles</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">angles</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dists</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
        <span class="c1"># Ordeno los bordes para que el de arriba quede primero</span>
        <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="o">*</span> <span class="n">dists</span>
        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">norm_dist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Sin bajalenguas&#39;</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">dangles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_angle_diff</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Sin bajalenguas - mal paralelismo&#39;</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">norm_dist</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max_width_proportion</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Sin bajalenguas - mal ratio&#39;</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">20.</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Sin bajalenguas - mala inclinacion&#39;</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Con bajalenguas&#39;</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">],</span> <span class="n">dists</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">limits</span></div></div>


<div class="viewcode-block" id="SearchParams"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.SearchParams">[docs]</a><span class="k">class</span> <span class="nc">SearchParams</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Parametros geometricos para EllipseFinder&quot;&quot;&quot;</span>
    <span class="n">TRY_EGGS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;major_axis&#39;</span><span class="p">]</span>
    <span class="n">STANDARD_MINOR_AXIS</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;minor_axis&#39;</span><span class="p">]</span>
    <span class="n">STANDARD_AREA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">*</span> <span class="n">STANDARD_MINOR_AXIS</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="c1"># Tolerancia para variaciones de tamanio</span>
    <span class="n">TOL</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">][</span><span class="s1">&#39;tolerance&#39;</span><span class="p">])</span>
    <span class="n">TOL</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">TOL</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Convertir de porcentaje a fraccion</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_size</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">dmin</span><span class="p">):</span>
        <span class="n">angles</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">im_size</span><span class="p">)</span>
        <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span> <span class="o">*</span> <span class="n">dists</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">norm_dist</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>  <span class="c1"># Ancho del bajalenguas</span>
        <span class="n">normalized_dists</span> <span class="o">=</span> <span class="n">dists</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">normalized_dists</span><span class="p">)</span>  <span class="c1"># Limites del bajalenguas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>  <span class="c1"># Tamaño de la region a inspeccionar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut_width_multi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cut_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Tamaño de la region para huevos multiples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="n">scale</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="n">scale</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">major_axis_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">major_axis_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">major_axis_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minor_axis_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MINOR_AXIS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minor_axis_down</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MINOR_AXIS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minor_axis_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MINOR_AXIS</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="k">if</span> <span class="n">dmin</span><span class="p">:</span>  <span class="c1"># Distancia minima entre regiones</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dmin</span> <span class="o">=</span> <span class="n">dmin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dmin</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">minor_axis_mean</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">report_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;area_up&#39;</span><span class="p">,</span> <span class="s1">&#39;area_down&#39;</span><span class="p">,</span> <span class="s1">&#39;major_axis_mean&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;minor_axis_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;cut_width&#39;</span><span class="p">,</span> <span class="s1">&#39;cut_width_multi&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;dmin&#39;</span><span class="p">,</span> <span class="s1">&#39;limits&#39;</span><span class="p">]</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">report_vars</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))))</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>

<div class="viewcode-block" id="EllipseFinder"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EllipseFinder">[docs]</a><span class="k">class</span> <span class="nc">EllipseFinder</span><span class="p">():</span>
    <span class="sd">u&quot;&quot;&quot;Busca elipses del tamaño definido en la configuración.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EllipseFinder.find_in"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EllipseFinder.find_in">[docs]</a>    <span class="k">def</span> <span class="nf">find_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_g</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_thres</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">thresh_step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">dmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">u&quot;&quot;&quot;Busca elipses del tamaño definido en la configuración.</span>

<span class="sd">        Para esto aplica una serie sucesiva de umbrales entre 0 y `max_thres`</span>
<span class="sd">        de a pasos definidos por `thresh_step`. En cada etapa busca manchas</span>
<span class="sd">        conexas de tamanios definidos en el archivo de configuracion e intenta</span>
<span class="sd">        ajustarlos por una o mas elipses</span>

<span class="sd">        Args:</span>
<span class="sd">            img_g (np.array): Imagen a analizar, si no es blanco y negro</span>
<span class="sd">                se convierte automaticamente.</span>
<span class="sd">            limits (number): Angulos y distancias de los bordes del</span>
<span class="sd">                bajalenguas (segun se obtienen de `StickAnalizerHough`).</span>
<span class="sd">            max_thres (float, optional): Maximo valor de intenisdad a usar</span>
<span class="sd">                como umbral para la imagen (0 es negro 1 es blanco)</span>
<span class="sd">            tresh_step (float, optional): Centroide de la elipse</span>
<span class="sd">            dmin (int, optional): Tamaño del template (matriz de `res` x `res`)</span>
<span class="sd">            show_settings (bool, optional): Tamaño del template (matriz de `res` x `res`</span>

<span class="sd">        Returns:</span>
<span class="sd">            status (str): Estado en el que termino la busqueda.</span>
<span class="sd">            res (numpy.array): Array de Nx5 donde N es el numero de regiones</span>
<span class="sd">                halladas. Las cinco columnas corresponden a las siguientes</span>
<span class="sd">                propiedades de cada region: centroide_i, centroide_j,</span>
<span class="sd">                correlacion, contraste, aspecto.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_g</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img_g</span> <span class="o">=</span> <span class="n">rgb2gray</span><span class="p">(</span><span class="n">img_g</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">limits</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;No busco sin bajalenguas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">SearchParams</span><span class="p">(</span><span class="n">img_g</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">dmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">cut_width</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Imagen con poca resolucion&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Numpy array para los resultados</span>
        <span class="c1"># Columnas: centroid_i, centroid_j, correlations, contrasts, aspects</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">seen_centroids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">show_settings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Loop Principal</span>
        <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_thres</span><span class="p">,</span> <span class="n">thresh_step</span><span class="p">):</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="n">img_g</span> <span class="o">&lt;</span> <span class="n">th</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="n">area_down</span> <span class="ow">or</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">area_up</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region_is_in_stick</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seen_centroids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">]),</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">seen_centroids</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dist_mat</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="n">dmin</span><span class="p">):</span>
                    <span class="k">continue</span>  <span class="c1"># Solo sigue si es un centroide nuevo</span>
                <span class="n">seen_centroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
                <span class="n">myreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_region</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span> <span class="n">img_g</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">cut_width</span><span class="p">)</span>
                <span class="n">recorte</span><span class="p">,</span> <span class="n">new_region</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">i_max_region</span> <span class="o">=</span> <span class="n">myreg</span>
                <span class="k">if</span> <span class="n">recorte</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">contrast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_contrast</span><span class="p">(</span><span class="n">recorte</span><span class="p">,</span> <span class="n">labels</span> <span class="o">==</span> <span class="p">(</span><span class="n">i_max_region</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">contrast</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Si el area es compatible con un solo huevo</span>
                <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="n">area_up</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">convex_area</span> <span class="o">&gt;</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># No seguir si la region es muy no-convexa</span>
                    <span class="n">min_ax</span> <span class="o">=</span> <span class="n">new_region</span><span class="o">.</span><span class="n">minor_axis_length</span>
                    <span class="n">maj_ax</span> <span class="o">=</span> <span class="n">new_region</span><span class="o">.</span><span class="n">major_axis_length</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">aspect</span> <span class="o">=</span> <span class="n">maj_ax</span> <span class="o">/</span> <span class="n">min_ax</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">aspect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_template</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">minor_axis_mean</span><span class="p">,</span>
                                                      <span class="n">p</span><span class="o">.</span><span class="n">major_axis_mean</span><span class="p">,</span>
                                                      <span class="o">-</span><span class="n">new_region</span><span class="o">.</span><span class="n">orientation</span><span class="p">,</span>
                                                      <span class="p">(</span><span class="n">new_region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                      <span class="mi">2</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">cut_width</span><span class="p">)</span>
                    <span class="n">correlation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nan_correlation</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">recorte</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">correlation</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;debug_mode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">correlation</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_debug</span><span class="p">(</span><span class="n">myreg</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dist_mat</span><span class="p">)</span>
                    <span class="n">c_i</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">cut_width</span>
                    <span class="n">c_j</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">cut_width</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="n">c_i</span><span class="p">,</span> <span class="n">c_j</span><span class="p">,</span> <span class="n">correlation</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">aspect</span><span class="p">]])</span>
                <span class="c1"># Si creemos que hay varios pegados</span>
                <span class="k">elif</span> <span class="n">region</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">area_up</span><span class="p">:</span>
                    <span class="n">myreg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut_region</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">,</span> <span class="n">img_g</span><span class="p">,</span>
                                            <span class="n">delta</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">cut_width_multi</span><span class="p">,</span> <span class="n">target_max</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">myreg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correlate_many_eggs</span><span class="p">(</span><span class="n">myreg</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                    <span class="n">temp_xcorrs</span><span class="p">,</span> <span class="n">temp_aspects</span><span class="p">,</span> <span class="n">temp_centroids</span> <span class="o">=</span> <span class="n">out</span>
                    <span class="n">i_max_corrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">temp_xcorrs</span><span class="p">)</span>
                    <span class="n">max_corr</span> <span class="o">=</span> <span class="n">temp_xcorrs</span><span class="p">[</span><span class="n">i_max_corrs</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">max_corr</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;debug_mode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">max_corr</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_debug</span><span class="p">(</span><span class="n">myreg</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dist_mat</span><span class="p">)</span>
                    <span class="c1"># Agregar los resultados   TERMINAR!</span>
                    <span class="n">add_corrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_corr</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">TRY_EGGS</span><span class="p">[</span><span class="n">i_max_corrs</span><span class="p">]</span>
                    <span class="n">add_aspects</span> <span class="o">=</span> <span class="n">temp_aspects</span><span class="p">[</span><span class="n">i_max_corrs</span><span class="p">]</span>
                    <span class="n">add_contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">contrast</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">TRY_EGGS</span><span class="p">[</span><span class="n">i_max_corrs</span><span class="p">]</span>
                    <span class="n">referenced_centroids</span> <span class="o">=</span> <span class="p">[(</span><span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">cut_width_multi</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">region</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">cut_width_multi</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">temp_centroids</span><span class="p">[</span><span class="n">i_max_corrs</span><span class="p">]</span>
                                            <span class="p">]</span>
                    <span class="n">referenced_centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">referenced_centroids</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">add_centroids_i</span><span class="p">,</span> <span class="n">add_centroids_j</span> <span class="o">=</span> <span class="n">referenced_centroids</span>
                    <span class="n">add_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">add_centroids_i</span><span class="p">,</span> <span class="n">add_centroids_j</span><span class="p">,</span>
                                         <span class="n">add_corrs</span><span class="p">,</span> <span class="n">add_contrasts</span><span class="p">,</span> <span class="n">add_aspects</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">add_res</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Status OK&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_plot_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">myreg</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dist_mat</span><span class="p">):</span>
        <span class="n">recorte</span><span class="p">,</span> <span class="n">new_region</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">i_max_region</span> <span class="o">=</span> <span class="n">myreg</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">recorte</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">waitforbuttonpress</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_correlate_many_eggs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">myreg</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calcula las correlaciones probando con templates de distinta</span>
<span class="sd">        cantidad de huevos. &quot;&quot;&quot;</span>
        <span class="n">recorte</span><span class="p">,</span> <span class="n">new_region</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">i_max_region</span> <span class="o">=</span> <span class="n">myreg</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i_max_region</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">temp_xcorrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_aspects</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">TRY_EGGS</span><span class="p">]</span>
        <span class="n">temp_centroids</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">TRY_EGGS</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iegg</span><span class="p">,</span> <span class="n">eggnum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">TRY_EGGS</span><span class="p">):</span>
            <span class="n">gm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">eggnum</span><span class="p">)</span>
            <span class="n">gm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">covariances</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gm</span><span class="o">.</span><span class="n">covariances_</span><span class="p">):</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">covariances</span><span class="p">)</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">v</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">aspect</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aspect</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">aspect</span> <span class="o">=</span> <span class="n">aspect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">temp_aspects</span><span class="p">[</span><span class="n">iegg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aspect</span><span class="p">)</span>
                <span class="n">temp_centroids</span><span class="p">[</span><span class="n">iegg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">gm</span><span class="o">.</span><span class="n">means_</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_template</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">minor_axis_mean</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">major_axis_mean</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">angle</span><span class="p">,</span>
                                           <span class="n">gm</span><span class="o">.</span><span class="n">means_</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">cut_width_multi</span><span class="p">)</span>
                <span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">templates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">template</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">template</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nan_correlation</span><span class="p">(</span><span class="n">recorte</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
            <span class="n">temp_xcorrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_xcorrs</span><span class="p">,</span> <span class="n">temp_aspects</span><span class="p">,</span> <span class="n">temp_centroids</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_correct_corr</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Corrige la correlacion por cantidad de parametros.</span>

<span class="sd">        Args:</span>
<span class="sd">            R (float): Correlacion</span>
<span class="sd">            n (int): Cantidad de datos</span>
<span class="sd">            k (int): Cantidad de parametros</span>
<span class="sd">        Returns:</span>
<span class="sd">            corrected (float): El valor corregido de R</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">corrected</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_nan_correlation</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">matrix2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calcula la correlacion entre dos matrices excluyendo los valores nan.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">matrix1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">matrix2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">gi</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">gi</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">corr_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EllipseFinder.cut_region"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EllipseFinder.cut_region">[docs]</a>    <span class="k">def</span> <span class="nf">cut_region</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">target_max</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recorta una region cuadrada alrededor de un punto.</span>

<span class="sd">        Luego de hacer el recorte se aplica un umbral con el metodo de Otsu</span>
<span class="sd">        para binarizar la imagen. Se conserva solo la region mas grande o la</span>
<span class="sd">        mas centra segun el valor de `target_max`</span>

<span class="sd">        Args:</span>
<span class="sd">            centroid (tuple of floats): Coordenadas (fila, columna) del centro</span>
<span class="sd">                alredeor del cual se recorta.</span>
<span class="sd">            img (numpy array): Imagen base a recortar.</span>
<span class="sd">            delta (int): Se recorta una distancia de +- delta alredeor del centro</span>
<span class="sd">            target_max (bool): Si es True, solo se conserva la region conexa</span>
<span class="sd">                mas grande. Si es False, se conserva la region conexa que esta</span>
<span class="sd">                en el centro.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">i_min</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">i_max</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">delta</span>
        <span class="k">if</span> <span class="n">i_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i_max</span> <span class="o">&gt;=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">j_min</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">delta</span>
        <span class="n">j_max</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">delta</span>
        <span class="k">if</span> <span class="n">j_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j_max</span> <span class="o">&gt;=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">recorte</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i_min</span><span class="p">:</span><span class="n">i_max</span><span class="p">,</span> <span class="n">j_min</span><span class="p">:</span><span class="n">j_max</span><span class="p">]</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">recorte</span><span class="p">)</span>
        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">recorte</span> <span class="o">&lt;</span> <span class="n">thresh</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">new_mask</span><span class="p">)</span>
        <span class="n">new_props</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_max</span><span class="p">:</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">new_props</span><span class="p">]</span>
            <span class="n">i_target_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i_target_region</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">new_region</span> <span class="o">=</span> <span class="n">new_props</span><span class="p">[</span><span class="n">i_target_region</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">recorte</span><span class="p">,</span> <span class="n">new_region</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">i_target_region</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EllipseFinder.calculate_contrast"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EllipseFinder.calculate_contrast">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_contrast</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calcula el contraste en una imagen en base a una mascara.&quot;&quot;&quot;</span>
        <span class="n">Imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">Imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="p">(</span><span class="n">Imax</span> <span class="o">-</span> <span class="n">Imin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Imax</span> <span class="o">+</span> <span class="n">Imin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contrast</span></div>

    <span class="k">def</span> <span class="nf">_region_is_in_stick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decide si una dada region esta o no dentro del bajalenguas.&quot;&quot;&quot;</span>
        <span class="n">ylimits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">centroid</span>
        <span class="k">for</span> <span class="n">angle</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="o">.</span><span class="n">limits</span><span class="p">):</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">ylimits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yl</span><span class="p">)</span>
        <span class="n">point_in_stick</span> <span class="o">=</span> <span class="p">(</span><span class="n">ys</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ylimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ys</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ylimits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">20</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">point_in_stick</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="EllipseFinder.generate_template"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EllipseFinder.generate_template">[docs]</a>    <span class="k">def</span> <span class="nf">generate_template</span><span class="p">(</span><span class="n">minor_axis</span><span class="p">,</span> <span class="n">major_axis</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">centroid</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crea un `template` de huevo.</span>

<span class="sd">        Args:</span>
<span class="sd">            - minor_axis (number): Eje menor de la elipse.</span>
<span class="sd">            - major_axis (number): Eje mayor de la elipse.</span>
<span class="sd">            - angle (float): Angulo de la elipse.</span>
<span class="sd">            - centroid (tuple of numbers): Centroide de la elipse</span>
<span class="sd">            - res (int): Tamaño del template (matriz de `res` x `res`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            - template (`res` x `res` array): template de un huevo de acuerdo</span>
<span class="sd">            a los parametrs dados.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">major_axis</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">minor_axis</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">Xcorr</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">xc</span><span class="p">)</span>
        <span class="n">Ycorr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">yc</span><span class="p">)</span>
        <span class="n">Zel</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Xcorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ycorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
               <span class="p">((</span><span class="n">Xcorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ycorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">/</span> <span class="n">B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="n">Zel_edge</span> <span class="o">=</span> <span class="p">(((</span><span class="n">Xcorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ycorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                    <span class="p">((</span><span class="n">Xcorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ycorr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">/</span> <span class="n">B</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Zel</span><span class="p">[</span><span class="n">Zel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Zel</span><span class="p">[(</span><span class="n">Zel_edge</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Zel_edge</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.1</span>
        <span class="n">Zel</span><span class="p">[(</span><span class="n">Zel</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Zel</span><span class="p">[(</span><span class="n">Zel</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)])</span>
        <span class="n">Zconv</span> <span class="o">=</span> <span class="n">convolve2d</span><span class="p">(</span><span class="n">Zel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">Zconv</span><span class="p">[</span><span class="n">Zel_edge</span> <span class="o">&gt;</span> <span class="mf">1.4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Zconv</span><span class="p">[</span><span class="n">Zel_edge</span> <span class="o">&gt;</span> <span class="mf">1.9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">Zconv</span></div></div>

<span class="c1">###############################################################################</span>
<span class="c1">#</span>
<span class="c1">#      A Partir de aca siguen los algoritmos viejos.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="StickAnalizerMulti"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti">[docs]</a><span class="k">class</span> <span class="nc">StickAnalizerMulti</span><span class="p">(</span><span class="n">StickAnalizer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Busca el bajalenguas con tres metodos distintos.</span>

<span class="sd">    Los tres metodos son:</span>
<span class="sd">     - A partir de los bordes.</span>
<span class="sd">     - Por el color.</span>
<span class="sd">     - Umbral de brillo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StickAnalizerMulti</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_patches</span><span class="p">()</span>

<div class="viewcode-block" id="StickAnalizerMulti.get_clipped_image"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti.get_clipped_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_clipped_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Devuelve la imagen recortada.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_stick</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_im</span></div>

    <span class="k">def</span> <span class="nf">_find_stick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">mask1</span><span class="p">,</span> <span class="n">disp1</span><span class="p">,</span> <span class="n">angle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polish_mask</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binary_by_colors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">target_colors</span><span class="p">,</span>
                                  <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
        <span class="n">mask2</span><span class="p">,</span> <span class="n">disp2</span><span class="p">,</span> <span class="n">angle2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polish_mask</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binary_by_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres_g</span><span class="p">))</span>
        <span class="n">mask3</span><span class="p">,</span> <span class="n">disp3</span><span class="p">,</span> <span class="n">angle3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polish_mask</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binary_by_thresholding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im_lowres_g</span><span class="p">))</span>

        <span class="c1"># Eligo el metodo que da menor disparidad</span>
        <span class="n">disparities</span> <span class="o">=</span> <span class="p">[</span><span class="n">disp1</span><span class="p">,</span> <span class="n">disp2</span><span class="p">,</span> <span class="n">disp3</span><span class="p">]</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">mask3</span><span class="p">]</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">,</span> <span class="n">angle3</span><span class="p">]</span>
        <span class="n">idx_min_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">disparities</span><span class="p">)</span>
        <span class="n">binary_image</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">idx_min_disp</span><span class="p">]</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="n">idx_min_disp</span><span class="p">]</span>

        <span class="c1"># Roto la imagen y la mascara</span>
        <span class="n">binary_image</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">binary_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">binary_image</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">binary_image</span><span class="p">,</span>
                              <span class="o">-</span><span class="n">orientation</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">rotated_curr_im</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_im</span><span class="p">,</span>
                                 <span class="o">-</span><span class="n">orientation</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rotated_curr_im</span><span class="p">[</span><span class="o">~</span><span class="n">binary_image</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                 <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">binary_image</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">binary_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>
        <span class="n">minrow</span><span class="p">,</span> <span class="n">mincol</span><span class="p">,</span> <span class="n">maxrow</span><span class="p">,</span> <span class="n">maxcol</span> <span class="o">=</span> <span class="n">roi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_im</span> <span class="o">=</span> <span class="n">rotated_curr_im</span><span class="p">[</span><span class="n">minrow</span><span class="p">:</span><span class="n">maxrow</span><span class="p">,</span> <span class="n">mincol</span><span class="p">:</span><span class="n">maxcol</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crear medias para extraccion por color a partir de recortes del</span>
<span class="sd">        bajalenguas&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">patch_dir</span> <span class="o">=</span> <span class="n">cfg_images</span><span class="p">[</span><span class="s1">&#39;patch_dir&#39;</span><span class="p">]</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">patch_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
            <span class="n">impatch</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patch_dir</span><span class="p">,</span> <span class="n">patch</span><span class="p">))</span>
            <span class="n">impatch_hsv</span> <span class="o">=</span> <span class="n">rgb2hsv</span><span class="p">(</span><span class="n">impatch</span><span class="p">)</span>
            <span class="n">segments_slic</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">slic</span><span class="p">(</span><span class="n">impatch</span><span class="p">,</span> <span class="n">n_segments</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                              <span class="n">compactness</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">segments_slic</span><span class="p">):</span>
                <span class="n">mediana</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">impatch_hsv</span><span class="p">[</span><span class="n">segments_slic</span> <span class="o">==</span> <span class="n">lab</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mediana</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="StickAnalizerMulti.binary_by_edges"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti.binary_by_edges">[docs]</a>    <span class="k">def</span> <span class="nf">binary_by_edges</span><span class="p">(</span><span class="n">img_g</span><span class="p">):</span>
        <span class="s2">&quot;Segmentacion por bordes&quot;</span>
        <span class="n">cedges</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">img_g</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">high_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                               <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">use_quantiles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cedges</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="StickAnalizerMulti.binary_by_thresholding"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti.binary_by_thresholding">[docs]</a>    <span class="k">def</span> <span class="nf">binary_by_thresholding</span><span class="p">(</span><span class="n">img_g</span><span class="p">):</span>
        <span class="s2">&quot;Segmentacion por umbral de intensidad&quot;</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">img_g</span><span class="p">)</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">img_g</span> <span class="o">&lt;</span> <span class="n">th</span>
        <span class="k">return</span> <span class="n">binary_mask</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="StickAnalizerMulti.binary_by_colors"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti.binary_by_colors">[docs]</a>    <span class="k">def</span> <span class="nf">binary_by_colors</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target_colors</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="s2">&quot;Segmentacion por color&quot;</span>
        <span class="n">segments_slic</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">slic</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">n_segments</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                                          <span class="n">compactness</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">rag_mean_color</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">segments_slic</span><span class="p">)</span>
        <span class="n">graphcut</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">cut_threshold</span><span class="p">(</span><span class="n">segments_slic</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">rag_mean_color</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">graphcut</span><span class="p">)</span>
        <span class="n">good_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">nid</span><span class="p">][</span><span class="s1">&#39;mean color&#39;</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">rgb2hsv</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">minimo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pairwise_distances</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">target_colors</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">minimo</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">good_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">graphcut</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gn</span> <span class="ow">in</span> <span class="n">good_nodes</span><span class="p">:</span>
            <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">binary_mask</span> <span class="o">+</span> <span class="p">(</span><span class="n">graphcut</span> <span class="o">==</span> <span class="n">gn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">binary_mask</span></div>

<div class="viewcode-block" id="StickAnalizerMulti.polish_mask"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti.polish_mask">[docs]</a>    <span class="k">def</span> <span class="nf">polish_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binary_mask</span><span class="p">):</span>
        <span class="s2">&quot;Elije la mejor region y completa huecos&quot;</span>
        <span class="n">filled</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">convex_hull_object</span><span class="p">(</span><span class="n">binary_mask</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>
        <span class="n">rprops</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rprops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">binary_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_disparity</span><span class="p">(</span><span class="n">rprops</span><span class="p">,</span>
                                             <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">binary_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">disparity</span><span class="p">)</span>
        <span class="n">polished_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="p">(</span><span class="n">I</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">polished_mask</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">convex_hull_image</span><span class="p">(</span><span class="n">polished_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">polished_mask</span><span class="p">,</span> <span class="n">disparity</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">rprops</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">.</span><span class="n">orientation</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_disparity_fun</span><span class="p">(</span><span class="n">geometric_props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calcula la disparidad entre las propiedades de una region y</span>
<span class="sd">        las propiedades objetivo elegidas en la configuracion&quot;&quot;&quot;</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;stick&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;stick&#39;</span><span class="p">][</span><span class="s1">&#39;geometry-weights&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">weights</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">geometric_props</span> <span class="o">/</span> <span class="n">targets</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="StickAnalizerMulti.calculate_disparity"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.StickAnalizerMulti.calculate_disparity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_disparity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rprops</span><span class="p">,</span> <span class="n">imarea</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;props&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calcula la disparidad entre todas las regiones candidatas y</span>
<span class="sd">        las propiedades objetivo elegidas en la configuracion</span>

<span class="sd">        Args:</span>
<span class="sd">            - rprops (list): Lista de propiedades de las regiones candidatas</span>
<span class="sd">            - imarea (int): Area de la imagen</span>
<span class="sd">            - method (str, optional): Metodo a utilizar para comparar las</span>
<span class="sd">                regiones con el objetivo. (Puede ser `props` o `hu`)</span>
<span class="sd">                    - `props`: usa tres propiedades geometricas.</span>
<span class="sd">                    - `hu`: usa los hu-moments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span>
            <span class="n">descriptors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rprops</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">descriptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">major_axis_length</span> <span class="o">/</span> <span class="n">r</span><span class="o">.</span><span class="n">minor_axis_length</span><span class="p">,</span>
                         <span class="n">r</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">major_axis_length</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">minor_axis_length</span><span class="p">),</span>
                         <span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="n">imarea</span>
                         <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">descriptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">999</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">999</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
            <span class="n">disparity</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_disparity_fun</span><span class="p">,</span> <span class="n">descriptors</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;hu&#39;</span><span class="p">:</span>
            <span class="n">MAX_MOMENT</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;stick&#39;</span><span class="p">][</span><span class="s1">&#39;max-hu&#39;</span><span class="p">]</span>
            <span class="n">TARGET_HU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;stick&#39;</span><span class="p">][</span><span class="s1">&#39;hu-moments&#39;</span><span class="p">])</span>
            <span class="n">disparity</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rprops</span><span class="p">:</span>
                <span class="n">disparity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">moments_hu</span><span class="p">[:</span><span class="n">MAX_MOMENT</span><span class="p">])</span> <span class="o">-</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TARGET_HU</span><span class="p">[:</span><span class="n">MAX_MOMENT</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No existe el metodo &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">disparity</span></div></div>


<div class="viewcode-block" id="EggFinder"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder">[docs]</a><span class="k">class</span> <span class="nc">EggFinder</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;default_dir&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;default_dir&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;aedes-model.pkl&#39;</span><span class="p">)</span>
    <span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;aedes-data-model.pkl&#39;</span><span class="p">)</span>
    <span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;major_axis&#39;</span><span class="p">]</span>
    <span class="n">STANDARD_MINOR_AXIS</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;minor_axis&#39;</span><span class="p">]</span>
    <span class="n">STANDARD_AREA</span> <span class="o">=</span> <span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">*</span> <span class="n">STANDARD_MINOR_AXIS</span>
    <span class="n">TOL</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;eggs&#39;</span><span class="p">][</span><span class="s1">&#39;tolerance&#39;</span><span class="p">]</span>  <span class="c1"># Tolerancia para variaciones de tamanio</span>
    <span class="n">TOL</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">TOL</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Convertir de porcentaje a fraccion</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span>

<div class="viewcode-block" id="EggFinder.find_in"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.find_in">[docs]</a>    <span class="k">def</span> <span class="nf">find_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;threshold&#39;</span><span class="p">):</span>
        <span class="n">curr_im_g</span> <span class="o">=</span> <span class="n">rgb2gray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="c1"># Segmento por color</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;threshold&#39;</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_im_g</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.07</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">curr_im_g</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_im_g</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;quickshift&#39;</span><span class="p">:</span>
            <span class="c1"># Los parametros deben ser adaptados a la escala de la imagen</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">quickshift</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                             <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                             <span class="n">max_dist</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                                             <span class="n">ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># Calculo propiedades de las regiones segmentadas</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="n">regionprops</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">intensity_image</span><span class="o">=</span><span class="n">curr_im_g</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">py</span><span class="p">,</span> <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">alto_im</span> <span class="o">=</span> <span class="n">curr_im_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="n">areas</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">alto_im</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">perimetros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">perimeter</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span>
        <span class="n">perimetros</span> <span class="o">=</span> <span class="n">perimetros</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">alto_im</span>
        <span class="n">major_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">major_axis_length</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span>
        <span class="n">major_axis</span> <span class="o">=</span> <span class="n">major_axis</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">alto_im</span>
        <span class="n">minor_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">minor_axis_length</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span>
        <span class="n">minor_axis</span> <span class="o">=</span> <span class="n">minor_axis</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">alto_im</span>
        <span class="n">convex_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">convex_area</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span>
        <span class="n">convex_areas</span> <span class="o">=</span> <span class="n">convex_areas</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">alto_im</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">diff_areas</span> <span class="o">=</span> <span class="n">convex_areas</span> <span class="o">-</span> <span class="n">areas</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">mean_intensity</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">gi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_candidates</span><span class="p">(</span><span class="n">minor_axis</span><span class="p">,</span> <span class="n">major_axis</span><span class="p">,</span> <span class="n">areas</span><span class="p">)</span>
        <span class="n">gi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minor_axis</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">areas</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">perimetros</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">major_axis</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span>
                                   <span class="n">minor_axis</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">diff_areas</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span>
                                   <span class="n">intensity</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">px</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">py</span><span class="p">[</span><span class="n">gi</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_filter_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minor_axis</span><span class="p">,</span> <span class="n">major_axis</span><span class="p">,</span> <span class="n">areas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filtra a los posibles candidatos en base a requisitos mínimos</span>
<span class="sd">        o máximos de tamaño&quot;&quot;&quot;</span>
        <span class="n">singles</span> <span class="o">=</span> <span class="p">((</span><span class="n">minor_axis</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MINOR_AXIS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">minor_axis</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MINOR_AXIS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">major_axis</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">major_axis</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_MAJOR_AXIS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">areas</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)</span> <span class="o">&amp;</span>
                   <span class="p">(</span><span class="n">areas</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)</span>
                   <span class="p">)</span>
        <span class="c1"># Esto es por si hay 2 o 3 huevos pegados</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="p">(((</span><span class="n">areas</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">))</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="n">areas</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)))</span> <span class="o">|</span>
                     <span class="p">((</span><span class="n">areas</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">))</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="n">areas</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_AREA</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOL</span><span class="p">)))</span>
                     <span class="p">)</span>
        <span class="n">good_indices</span> <span class="o">=</span> <span class="n">singles</span> <span class="o">|</span> <span class="n">multiples</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total singles: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">singles</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total multiples: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">multiples</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">singles</span> <span class="o">+</span> <span class="n">multiples</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">good_indices</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">good_indices</span>

<div class="viewcode-block" id="EggFinder.classify"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.classify">[docs]</a>    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="EggFinder.start_trainning"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.start_trainning">[docs]</a>    <span class="k">def</span> <span class="nf">start_trainning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span></div>

<div class="viewcode-block" id="EggFinder.push_user_input"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.push_user_input">[docs]</a>    <span class="k">def</span> <span class="nf">push_user_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span><span class="p">,</span> <span class="n">targets</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span><span class="p">,</span> <span class="n">measures</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Carga el modelo de clasificador de de arbol (DecisionTree)&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_PATH</span><span class="p">):</span>
            <span class="n">model_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
            <span class="n">model_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Model&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Carga datos guardados de entrenamiento&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_PATH</span><span class="p">):</span>
            <span class="n">model_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
            <span class="n">model_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Data&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="EggFinder.test_model"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.test_model">[docs]</a>    <span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Medir el desempeño del clasificador&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span><span class="p">,</span>
                                 <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Score F1: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span></div>

<div class="viewcode-block" id="EggFinder.save_data"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.save_data">[docs]</a>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Guardar datos de entrenamiento&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span><span class="p">)</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">)</span>
        <span class="n">data_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="EggFinder.save_model"><a class="viewcode-back" href="../../detector_aedes.html#detector_aedes.analyzers.EggFinder.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Guardar modelo entrenado&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_measures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_targets</span><span class="p">)</span>
        <span class="n">model_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_PATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
        <span class="n">model_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Datos Argentina.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>